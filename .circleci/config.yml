version: 2.1

executors:
  node_executor:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project

jobs:
  build_test:
    executor: node_executor
    environment:
      NODE_ENV: test
      CI: "true"

      # ===== required by your env schema (CI-safe values) =====
      # arrays are passed as JSON strings if your schema parses JSON
      CORS_ORIGIN: '["http://localhost:5173","http://127.0.0.1:5173","http://example.com"]'

      # length-constrained secrets
      PWD_PEPPER: "ci_pwd_pepper_1234567890abcd"        # 28+ chars
      JWT_SECRET: "ci_jwt_secret_1234567890_abcdefghijklmno1234567890"  # 48+ chars
      DATA_KEY: "ci_data_key_1234567890abcd"

      # mail (dummy)
      SMTP_HOST: "ci"
      SMTP_USER: "ci"
      SMTP_PASS: "ci"
      EMAIL_FROM: "ci@example.com"
      SEND_EMAILS: "false"

      # add any other strict keys your schema requires here
      # GOOGLE_CLIENT_ID: "ci"
      # GOOGLE_CLIENT_SECRET: "ci"
      # CLOUDINARY_URL: "cloudinary://ci:ci@ci"
      # PAYFAST_MERCHANT_ID: "ci"
      # PAYFAST_MERCHANT_KEY: "ci"

    steps:
      - checkout
      - run:
          name: Install deps (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm ci
      - run:
          name: Run tests with coverage (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm test -- --coverage --coverageReporters=lcov
      - run:
          name: Install deps (frontend) if present
          command: |
            if [ -f INSY7314-PAYMENT_PORTAL/frontend/package.json ]; then
              cd INSY7314-PAYMENT_PORTAL/frontend
              npm ci
            fi
      - run:
          name: Run tests with coverage (frontend) if present
          command: |
            if [ -f INSY7314-PAYMENT_PORTAL/frontend/package.json ]; then
              cd INSY7314-PAYMENT_PORTAL/frontend
              npm test -- --coverage --coverageReporters=lcov
            fi

  sonar_scan:
    executor: node_executor
    steps:
      - checkout
      - run:
          name: Install Java (required by sonar-scanner)
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jre-headless
            java -version
      - run:
          name: Download sonar-scanner
          command: |
            curl -sSLo sonar-scanner.zip \
              https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-5.0.1.3006-linux.zip
            unzip -q sonar-scanner.zip
            echo 'export PATH="$PWD/sonar-scanner-5.0.1.3006-linux/bin:$PATH"' >> $BASH_ENV
            echo 'export SONAR_SCANNER_OPTS="-Xmx1024m"' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Run SonarCloud analysis
          command: |
            sonar-scanner \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN

workflows:
  build_pipeline:
    jobs:
      - build_test
      - sonar_scan:
          requires:
            - build_test
