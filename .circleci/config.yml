version: 2.1

executors:
  node_with_mongo:
    docker:
      - image: cimg/node:20.11
      - image: mongo:7.0
    working_directory: ~/project

  node_exec:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project

jobs:
  build_test:
    executor: node_with_mongo
    environment:
      NODE_ENV: test
      NODE_OPTIONS: --experimental-vm-modules
      CI: "true"
      # --- Backend env (dummy but valid) ---
      CORS_ORIGIN: https://localhost:5173
      PWD_PEPPER: pepper_dev_secret_123456
      JWT_SECRET: jwt_dev_secret_abcdefghijklmnopqrstuvwxyz_1234567890
      DATA_KEY: a62b387f8738226611b593ce0d3aa9f134a60307c8b9bf6e5c4b4d3d7e0044b8
      MONGO_URI: mongodb://127.0.0.1:27017/testdb
      SEND_EMAILS: "false"
      SMTP_HOST: localhost
      SMTP_USER: ci@example.com
      SMTP_PASS: dummy-password
      EMAIL_FROM: ci@example.com
      ACCESS_TOKEN_TTL_MIN: "15"
      REFRESH_TOKEN_TTL_DAYS: "7"
    steps:
      - checkout

      - run:
          name: Install netcat for port checks
          command: |
            sudo apt-get update
            sudo apt-get install -y netcat-openbsd

      - run:
          name: Wait for Mongo (max 120s)
          command: |
            for i in $(seq 1 60); do
              if nc -z 127.0.0.1 27017; then
                echo "Mongo is up âœ”"; break
              fi
              echo "Waiting for Mongo... ($i/60)"
              sleep 2
            done

      # --- Backend ---
      - run:
          name: Install deps (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - run:
          name: Lint backend (non-blocking)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm run lint || true

      - run:
          name: Jest coverage (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm test --runInBand --coverage --coverageReporters=lcov

      # --- Frontend ---
      - run:
          name: Install deps (frontend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/frontend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - run:
          name: Jest coverage (frontend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/frontend
            npm test --runInBand --coverage --coverageReporters=lcov

      # --- Coverage fallback ---
      - run:
          name: Ensure coverage exists for Sonar
          command: |
            set -euxo pipefail
            COV_DIR_B="INSY7314-PAYMENT_PORTAL/backend/coverage"
            COV_DIR_F="INSY7314-PAYMENT_PORTAL/frontend/coverage"
            mkdir -p "$COV_DIR_B" "$COV_DIR_F"
            [ -f "$COV_DIR_B/lcov.info" ] || echo "TN:" > "$COV_DIR_B/lcov.info"
            [ -f "$COV_DIR_F/lcov.info" ] || echo "TN:" > "$COV_DIR_F/lcov.info"
            ls -lah "$COV_DIR_B" "$COV_DIR_F" || true

      # persist the project for the sonar job
      - persist_to_workspace:
          root: .
          paths:
            - INSY7314-PAYMENT_PORTAL

  # Sonar scan using remote Docker (no bind mounts; uses a volume container)
  sonar_scan_official:
    executor: node_exec
    environment:
      SONAR_HOST_URL: https://sonarcloud.io
      # SONAR_TOKEN must be set in CircleCI project variables
    steps:
      - checkout
      - attach_workspace:
          at: .

      - setup_remote_docker:
          docker_layer_caching: false

      # Create a volume container and copy project into it
      - run:
          name: Prepare source volume for remote Docker
          command: |
            set -euxo pipefail
            docker rm -f srcvol || true
            docker create -v /src --name srcvol alpine:3.20 /bin/true
            # copy only the subfolder we need
            docker cp INSY7314-PAYMENT_PORTAL/. srcvol:/src

            # verify inside the volume container
            docker run --rm --volumes-from srcvol alpine:3.20 sh -lc '
              echo "== /src ==" && ls -al /src;
              echo "== /src/backend ==" && ls -al /src/backend || true;
              echo "== /src/backend/src ==" && ls -al /src/backend/src || true;
              echo "== /src/backend/tests ==" && ls -al /src/backend/tests || true;
              echo "== /src/frontend ==" && ls -al /src/frontend || true;
              echo "== /src/frontend/src ==" && ls -al /src/frontend/src || true;
              echo "== coverage files ==";
              ls -al /src/backend/coverage/lcov.info || true;
              ls -al /src/frontend/coverage/lcov.info || true;
            '

      # Run Sonar scanner using the volume container
      - run:
          name: SonarCloud scan (remote Docker safe)
          command: |
            set -euxo pipefail

            # Build optional sonar.tests property only if folders exist
            TESTS_PROP=""
            docker run --rm --volumes-from srcvol alpine:3.20 sh -lc '
              [ -d /src/backend/tests ] && echo backend/tests || true
            ' > /tmp/btests || true
            docker run --rm --volumes-from srcvol alpine:3.20 sh -lc '
              [ -d /src/frontend/tests ] && echo frontend/tests || true
            ' > /tmp/ftests || true

            if [ -s /tmp/btests ] || [ -s /tmp/ftests ]; then
              TESTS_PROP="-Dsonar.tests=$(paste -sd, /tmp/btests /tmp/ftests | sed "s/^,//;s/,$//")"
            fi

            docker run --rm \
              --volumes-from srcvol \
              -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
              -e SONAR_TOKEN="${SONAR_TOKEN}" \
              sonarsource/sonar-scanner-cli \
              -Dsonar.organization="bradencalebperumal" \
              -Dsonar.projectKey="BradenCalebPerumal_INSY7314POE" \
              -Dsonar.projectName="INSY7314POE" \
              -Dsonar.sourceEncoding="UTF-8" \
              -Dsonar.projectBaseDir="/src" \
              -Dsonar.sources="backend/src,frontend/src" \
              -Dsonar.test.inclusions="**/*.{test,spec}.{js,jsx,ts,tsx}" \
              -Dsonar.exclusions="**/node_modules/**,**/dist/**,**/build/**,**/bin/**,**/obj/**" \
              -Dsonar.javascript.lcov.reportPaths="backend/coverage/lcov.info,frontend/coverage/lcov.info" \
              ${TESTS_PROP:+$TESTS_PROP}

workflows:
  build_pipeline:
    jobs:
      - build_test
      - sonar_scan_official:
          requires:
            - build_test
