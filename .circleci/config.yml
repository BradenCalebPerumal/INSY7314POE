version: 2.1

executors:
  node_with_mongo:
    docker:
      # Primary container where your steps run
      - image: cimg/node:20.11
        environment:
          NODE_ENV: test
          NODE_OPTIONS: --experimental-vm-modules
          CI: "true"
          # minimal env for your env validation in CI
          CORS_ORIGIN: https://localhost:5173
          PWD_PEPPER: dummy_pepper_for_ci_1234
          JWT_SECRET: 0123456789abcdef0123456789abcdef0123456789abcdef
          DATA_KEY: a62b387f8738226611b593ce0d3aa9f134a60307c8b9bf6e5c4b4d3d7e0044b8
          MONGO_URI: mongodb://localhost:27017/testdb   # <-- service container is reachable via localhost
          SEND_EMAILS: "false"
          SMTP_HOST: "localhost"
          SMTP_USER: "ci"
          SMTP_PASS: "ci"
      # MongoDB service container (no auth)
      - image: mongo:7
    working_directory: ~/project

  sonar_executor:
    docker:
      - image: sonarsource/sonar-scanner-cli:5.0.1
    working_directory: ~/project

jobs:
  build_test:
    executor: node_with_mongo
    steps:
      - checkout

      - run:
          name: Wait for Mongo to be ready
          command: |
            for i in $(seq 1 60); do
              (echo > /dev/tcp/localhost/27017) >/dev/null 2>&1 && echo "Mongo up" && break
              echo "Waiting for Mongo..."
              sleep 1
            done

      - run:
          name: Install deps (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi

      - run:
          name: Jest coverage (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm test --runInBand --coverage --coverageReporters=lcov

      - run:
          name: Ensure coverage exists for Sonar
          command: |
            set -euxo pipefail
            COV_DIR="INSY7314-PAYMENT_PORTAL/backend/coverage"
            mkdir -p "$COV_DIR"
            if [ ! -f "$COV_DIR/lcov.info" ]; then
              echo "TN:" > "$COV_DIR/lcov.info"
              echo "Created placeholder $COV_DIR/lcov.info"
            fi
            ls -lah "$COV_DIR" || true

      - persist_to_workspace:
          root: .
          paths:
            - INSY7314-PAYMENT_PORTAL/backend/coverage

  sonar_scan:
    executor: sonar_executor
    environment:
      SONAR_HOST_URL: https://sonarcloud.io
      # SONAR_TOKEN must be set in CircleCI Project Settings â†’ Environment Variables
    steps:
      - checkout
      - attach_workspace:
          at: .

      - run:
          name: Show repo tree for debugging
          command: |
            ls -la
            ls -la INSY7314-PAYMENT_PORTAL || true
            ls -la INSY7314-PAYMENT_PORTAL/backend || true
            ls -la INSY7314-PAYMENT_PORTAL/frontend || true

      - run:
          name: Build sonar sources list (backend/src + optional frontend/src)
          command: |
            set -e
            BASE="INSY7314-PAYMENT_PORTAL"
            SRC_LIST="backend/src"
            if [ -d "$BASE/frontend/src" ]; then
              SRC_LIST="$SRC_LIST,frontend/src"
            fi
            echo "SOURCES=$SRC_LIST" >> $BASH_ENV
            echo "Computed SOURCES=$SRC_LIST"

      - run:
          name: SonarCloud scan
          command: |
            source $BASH_ENV
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.organization="bradencalebperumal" \
              -Dsonar.projectKey="bradencalebperumal_INSY7314POE" \
              -Dsonar.projectName="INSY7314POE" \
              -Dsonar.sourceEncoding="UTF-8" \
              -Dsonar.projectBaseDir="INSY7314-PAYMENT_PORTAL" \
              -Dsonar.sources="${SOURCES}" \
              -Dsonar.exclusions="**/node_modules/**,**/dist/**,**/build/**,**/bin/**,**/obj/**" \
              -Dsonar.test.inclusions="**/*.{test,spec}.{js,jsx,ts,tsx}" \
              -Dsonar.javascript.lcov.reportPaths="backend/coverage/lcov.info"

workflows:
  build_pipeline:
    jobs:
      - build_test
      - sonar_scan:
          requires:
            - build_test
