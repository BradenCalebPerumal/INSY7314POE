version: 2.1

orbs:
  sonarcloud: sonarsource/sonarcloud@2.0.0

jobs:
  build_test:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project
    environment:
      NODE_ENV: test
      NODE_OPTIONS: --experimental-vm-modules
      CI: "true"
      CORS_ORIGIN: https://localhost:5173
      PWD_PEPPER: dummy_pepper_for_ci
      JWT_SECRET: 0123456789abcdef0123456789abcdef0123456789abcdef
      DATA_KEY: a62b387f8738226611b593ce0d3aa9f134a60307c8b9bf6e5c4b4d3d7e0044b8
      MONGO_URI: mongodb://127.0.0.1:27017/testdb
      SMTP_HOST: smtp.example.com
      SMTP_USER: ci@example.com
      SMTP_PASS: dummy123
      EMAIL_FROM: ci@example.com
      SEND_EMAILS: "false"
      ACCESS_TOKEN_TTL_MIN: "15"
      REFRESH_TOKEN_TTL_DAYS: "7"
    steps:
      - checkout
      - run:
          name: Install deps (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - run:
          name: Lint backend (non-blocking)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm run lint || true
      - run:
          name: Run tests with coverage (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm test --runInBand --coverage --coverageReporters=lcov
      - run:
          name: Frontend install/lint/build (if present)
          command: |
            if [ -f INSY7314-PAYMENT_PORTAL/frontend/package.json ]; then
              cd INSY7314-PAYMENT_PORTAL/frontend
              if [ -f package-lock.json ]; then npm ci; else npm install; fi
              npm run lint || true
              npm run build --if-present || npx vite build
            fi
      # ðŸ‘‰ Scanner runs here, no downloads, no custom Docker tags
      - sonarcloud/scan:
          sonar-token-variable-name: SONAR_TOKEN
          additional-arguments: >
            -Dsonar.organization=bradencalebperumal
            -Dsonar.projectKey=bradencalebperumal_INSY7314POE
            -Dsonar.projectName=INSY7314POE
            -Dsonar.projectBaseDir=INSY7314-PAYMENT_PORTAL
            -Dsonar.sources=INSY7314-PAYMENT_PORTAL/backend/src,INSY7314-PAYMENT_PORTAL/frontend/src
            -Dsonar.tests=INSY7314-PAYMENT_PORTAL/backend/tests,INSY7314-PAYMENT_PORTAL/frontend/tests
            -Dsonar.exclusions=**/node_modules/**,**/dist/**,**/build/**,**/bin/**,**/obj/**
            -Dsonar.javascript.lcov.reportPaths=INSY7314-PAYMENT_PORTAL/backend/coverage/lcov.info

workflows:
  build_pipeline:
    jobs:
      - build_test
