version: 2.1

executors:
  node_with_mongo:
    # ... (unchanged)
    docker:
      - image: cimg/node:20.11
      - image: mongo:7.0
    working_directory: ~/project

  # Standard executor for Sonar Scan steps
  node_exec:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project

jobs:
  build_test:
    # ... (all steps remain unchanged)
    steps:
      # ... (previous steps)
      - persist_to_workspace:
          root: .
          # CRITICAL: Persist the entire project folder for the scanner container to access all source files
          paths:
            - INSY7314-PAYMENT_PORTAL 
            
  # üèÜ FINAL, STABLE JOB: Runs the scan using the official SonarSource image with remote Docker
  sonar_scan_official:
    executor: node_exec
    environment:
      SONAR_HOST_URL: https://sonarcloud.io
      SONAR_TOKEN: "${SONAR_TOKEN}" # Ensure this is set as a CircleCI environment variable
    steps:
      - checkout
      - attach_workspace:
          at: .
      
      # 1. CRITICAL FIX: Set up a remote Docker environment
      - setup_remote_docker:
          docker_layer_caching: false
      
      # 2. The 'docker run' command executes the Sonar scan using the official image
      - run:
          name: SonarCloud scan using official image (Path Fix)
          command: |
            # Mount the entire CircleCI project workspace into the container at /usr/src
            docker run --rm \
              -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
              -e SONAR_TOKEN="${SONAR_TOKEN}" \
              -v "$(pwd):/usr/src" \
              sonarsource/sonar-scanner-cli \
              -Dsonar.organization="bradencalebperumal" \
              -Dsonar.projectKey="BradenCalebPerumal_INSY7314POE" \
              -Dsonar.projectName="INSY7314POE" \
              -Dsonar.sourceEncoding="UTF-8" \
              # CRITICAL PATH FIX: Base directory is the subfolder inside the container
              -Dsonar.projectBaseDir="/usr/src/INSY7314-PAYMENT_PORTAL" \
              -Dsonar.sources="backend/src,frontend/src" \
              -Dsonar.exclusions="**/node_modules/**,**/dist/**,**/build/**,**/bin/**,**/obj/**" \
              -Dsonar.test.inclusions="**/*.{test,spec}.{js,jsx,ts,tsx}" \
              -Dsonar.javascript.lcov.reportPaths="backend/coverage/lcov.info,frontend/coverage/lcov.info"

workflows:
  build_pipeline:
    jobs:
      - build_test
      # Use the stable, path-corrected job
      - sonar_scan_official:
          requires:
            - build_test