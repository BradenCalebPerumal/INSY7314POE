version: 2.1

executors:
  node_executor:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project

jobs:
  build_test:
    executor: node_executor
    environment:
      # match GH Actions
      NODE_ENV: test
      NODE_OPTIONS: --experimental-vm-modules
      CI: "true"

      # ===== satisfy your backend env schema (same vars as your GH workflow) =====
      # use a single plain string (NOT JSON) so your parser doesn't reject it
      CORS_ORIGIN: https://localhost:5173

      # length/format-constrained secrets (dummy but valid)
      PWD_PEPPER: dummy_pepper_for_ci                     # ≥16 chars
      JWT_SECRET: 0123456789abcdef0123456789abcdef0123456789abcdef   # ≥32 chars
      DATA_KEY: a62b387f8738226611b593ce0d3aa9f134a60307c8b9bf6e5c4b4d3d7e0044b8  # 64 hex

      # DB (if tests don’t connect, it won’t be used; still satisfies schema)
      MONGO_URI: mongodb://127.0.0.1:27017/testdb

      # mail (dummy)
      SMTP_HOST: smtp.example.com
      SMTP_USER: ci@example.com
      SMTP_PASS: dummy123
      EMAIL_FROM: ci@example.com
      SEND_EMAILS: "false"

      # tokens ttl (strings)
      ACCESS_TOKEN_TTL_MIN: "15"
      REFRESH_TOKEN_TTL_DAYS: "7"

    steps:
      - checkout

      # ---- BACKEND ----
      - run:
          name: Install deps (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - run:
          name: Lint backend (non-blocking)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm run lint || true
      - run:
          name: Run tests with coverage (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm test --runInBand --coverage --coverageReporters=lcov

      # ---- FRONTEND (optional; runs only if folder exists) ----
      - run:
          name: Install deps (frontend) if present
          command: |
            if [ -f INSY7314-PAYMENT_PORTAL/frontend/package.json ]; then
              cd INSY7314-PAYMENT_PORTAL/frontend
              if [ -f package-lock.json ]; then npm ci; else npm install; fi
            fi
      - run:
          name: Lint frontend (non-blocking) if present
          command: |
            if [ -f INSY7314-PAYMENT_PORTAL/frontend/package.json ]; then
              cd INSY7314-PAYMENT_PORTAL/frontend
              npm run lint || true
            fi
      - run:
          name: Build frontend (if present)
          command: |
            if [ -f INSY7314-PAYMENT_PORTAL/frontend/package.json ]; then
              cd INSY7314-PAYMENT_PORTAL/frontend
              npm run build --if-present || npx vite build
            fi

  sonar_scan:
    executor: node_executor
    steps:
      - checkout
      - run:
          name: Install Java (required by sonar-scanner)
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-17-jre-headless
            java -version
      - run:
          name: Download sonar-scanner
          command: |
            curl -sSLo sonar-scanner.zip \
              https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-5.0.1.3006-linux.zip
            unzip -q sonar-scanner.zip
            echo 'export PATH="$PWD/sonar-scanner-5.0.1.3006-linux/bin:$PATH"' >> $BASH_ENV
            echo 'export SONAR_SCANNER_OPTS="-Xmx1024m"' >> $BASH_ENV
            source $BASH_ENV
      - run:
          name: Run SonarCloud analysis
          command: |
            sonar-scanner \
              -Dsonar.host.url=https://sonarcloud.io \
              -Dsonar.login=$SONAR_TOKEN

workflows:
  build_pipeline:
    jobs:
      - build_test
      - sonar_scan:
          requires:
            - build_test
