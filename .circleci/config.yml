version: 2.1

executors:
  node_with_mongo:
    docker:
      - image: cimg/node:20.11
      - image: mongo:7.0
    working_directory: ~/project

  sonar_exec:
    docker:
      - image: sonarsource/sonar-scanner-cli:5.0.1
    working_directory: ~/project

jobs:
  build_test:
    executor: node_with_mongo
    environment:
      # ... (environment variables remain unchanged)
    steps:
      - checkout
      # ... (Install netcat and Wait for Mongo steps remain unchanged)
      
      # --- Backend Steps ---
      - run:
          name: Install deps (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - run:
          name: Lint backend (non-blocking)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm run lint || true
      - run:
          name: Jest coverage (backend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/backend
            npm test --runInBand --coverage --coverageReporters=lcov

      # --- Frontend Steps ---
      - run:
          name: Install deps (frontend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/frontend
            if [ -f package-lock.json ]; then npm ci; else npm install; fi
      - run:
          name: Jest coverage (frontend)
          command: |
            cd INSY7314-PAYMENT_PORTAL/frontend
            npm test --runInBand --coverage --coverageReporters=lcov

      # --- Coverage Setup ---
      - run:
          name: Ensure coverage exists for Sonar
          command: |
            set -euxo pipefail
            COV_DIR_B="INSY7314-PAYMENT_PORTAL/backend/coverage"
            COV_DIR_F="INSY7314-PAYMENT_PORTAL/frontend/coverage"
            mkdir -p "$COV_DIR_B" "$COV_DIR_F"
            # Create a minimal LCOV if tests didn't produce one
            if [ ! -f "$COV_DIR_B/lcov.info" ]; then echo "TN:" > "$COV_DIR_B/lcov.info"; fi
            if [ ! -f "$COV_DIR_F/lcov.info" ]; then echo "TN:" > "$COV_DIR_F/lcov.info"; fi
            ls -lah "$COV_DIR_B" "$COV_DIR_F" || true

      - persist_to_workspace:
          root: .
          paths:
            - INSY7314-PAYMENT_PORTAL/backend/coverage
            - INSY7314-PAYMENT_PORTAL/frontend/coverage

  sonar_scan:
    executor: sonar_exec
    environment:
      SONAR_HOST_URL: https://sonarcloud.io
      # SONAR_TOKEN must be set in CircleCI project env vars
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: SonarCloud scan
          command: |
            sonar-scanner -X \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.organization="bradencalebperumal" \
              -Dsonar.projectKey="BradenCalebPerumal_INSY7314POE" \
              -Dsonar.projectName="INSY7314POE" \
              -Dsonar.sourceEncoding="UTF-8" \
              -Dsonar.projectBaseDir="INSY7314-PAYMENT_PORTAL" \
              -Dsonar.sources="backend/src,frontend/src" \
              -Dsonar.exclusions="**/node_modules/**,**/dist/**,**/build/**,**/bin/**,**/obj/**" \
              -Dsonar.test.inclusions="**/*.{test,spec}.{js,jsx,ts,tsx}" \
              -Dsonar.javascript.lcov.reportPaths="backend/coverage/lcov.info,frontend/coverage/lcov.info"

workflows:
  build_pipeline:
    jobs:
      - build_test
      - sonar_scan:
          requires:
            - build_test