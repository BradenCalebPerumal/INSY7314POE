version: 2.1

executors:
  node_with_mongo:
    docker:
      - image: cimg/node:20.11
      - image: mongo:7.0
    working_directory: ~/project

  # ðŸ†• Executor for Sonar Scan steps (uses standard Node for file operations)
  node_exec:
    docker:
      - image: cimg/node:20.11
    working_directory: ~/project

# --- sonar_exec executor is removed as we are not using a custom image ---

jobs:
  build_test:
    executor: node_with_mongo
    environment:
      # ... (All existing environment variables remain)
      NODE_ENV: test
      NODE_OPTIONS: --experimental-vm-modules
      CI: "true"
      # ... (CORS, PWD_PEPPER, JWT, etc. remain unchanged)
      ACCESS_TOKEN_TTL_MIN: "15"
      REFRESH_TOKEN_TTL_DAYS: "7"
    steps:
      - checkout
      # ... (Netcat install, Wait for Mongo, Backend/Frontend installs/tests remain unchanged)
      - run:
          name: Ensure coverage exists for Sonar
          command: |
            set -euxo pipefail
            COV_DIR_B="INSY7314-PAYMENT_PORTAL/backend/coverage"
            COV_DIR_F="INSY7314-PAYMENT_PORTAL/frontend/coverage"
            mkdir -p "$COV_DIR_B" "$COV_DIR_F"
            if [ ! -f "$COV_DIR_B/lcov.info" ]; then echo "TN:" > "$COV_DIR_B/lcov.info"; fi
            if [ ! -f "$COV_DIR_F/lcov.info" ]; then echo "TN:" > "$COV_DIR_F/lcov.info"; fi
            ls -lah "$COV_DIR_B" "$COV_DIR_F" || true

      - persist_to_workspace:
          root: .
          # Must persist the entire project folder (INSY7314-PAYMENT_PORTAL) for the scanner container to access all source files
          paths:
            - INSY7314-PAYMENT_PORTAL 
            
  # ðŸ†• NEW JOB: Uses the official, stable SonarScanner image via Docker-in-Docker (DinD) style command
  sonar_scan_official:
    executor: node_exec
    environment:
      SONAR_HOST_URL: https://sonarcloud.io
      # SONAR_TOKEN must be set in CircleCI project env vars
    steps:
      - checkout
      - attach_workspace:
          at: .
      
      # 1. Install Docker CLI (since it's not always in cimg/node by default)
      # This enables the 'docker run' command below.
      - run:
          name: Install Docker CLI
          command: |
            sudo apt-get update && sudo apt-get install -y docker.io

      - run:
          name: SonarCloud scan using official image
          # We use 'docker run' to launch the official scanner image, mounting the source code
          command: |
            docker run --rm \
              -e SONAR_HOST_URL="${SONAR_HOST_URL}" \
              -e SONAR_TOKEN="${SONAR_TOKEN}" \
              -v "$(pwd)/INSY7314-PAYMENT_PORTAL:/usr/src" \
              sonarsource/sonar-scanner-cli \
              -Dsonar.organization="bradencalebperumal" \
              -Dsonar.projectKey="BradenCalebPerumal_INSY7314POE" \
              -Dsonar.projectName="INSY7314POE" \
              -Dsonar.sourceEncoding="UTF-8" \
              -Dsonar.projectBaseDir="/usr/src" \
              -Dsonar.sources="backend/src,frontend/src" \
              -Dsonar.exclusions="**/node_modules/**,**/dist/**,**/build/**,**/bin/**,**/obj/**" \
              -Dsonar.test.inclusions="**/*.{test,spec}.{js,jsx,ts,tsx}" \
              -Dsonar.javascript.lcov.reportPaths="/usr/src/backend/coverage/lcov.info,/usr/src/frontend/coverage/lcov.info"

workflows:
  build_pipeline:
    jobs:
      - build_test
      # Use the new job that relies on the official image
      - sonar_scan_official:
          requires:
            - build_test