# .circleci/config.yml
version: 2.1

executors:
  docker_cli:
    docker:
      - image: cimg/base:stable
    working_directory: ~/project

  sonar_exec:
    docker:
      - image: sonarsource/sonar-scanner-cli:5.0.1
    working_directory: ~/project

jobs:
  test_in_docker:
    executor: docker_cli
    steps:
      - checkout
      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Build compose images
          command: docker compose build --pull

      - run:
          name: Start Mongo
          command: docker compose up -d mongo

      - run:
          name: Wait for Mongo
          command: |
            for i in $(seq 1 60); do
              docker run --rm --network "$(basename $PWD)_default" busybox sh -c "nc -z mongo 27017" \
                && echo "Mongo is up" && exit 0 || echo "Waiting for Mongo..."
              sleep 1
            done
            echo "Mongo not ready" && exit 1

      - run:
          name: Run tests inside API container
          command: |
            rm -rf coverage-out
            mkdir -p coverage-out
            docker compose run --rm api sh -c "
              npm ci &&
              npm test --runInBand --coverage --coverageReporters=lcov &&
              mkdir -p /usr/src/app/coverage &&
              cp -f coverage/lcov.info /usr/src/app/coverage/lcov.info
            "
            docker cp $(docker ps -aqf "name=insy7314-api-dev"):/usr/src/app/coverage/lcov.info ./coverage-out/lcov.info || true

      - run:
          name: Verify coverage
          command: |
            ls -lah coverage-out || true
            test -f coverage-out/lcov.info || (echo "lcov.info missing" && exit 1)

      - persist_to_workspace:
          root: .
          paths:
            - coverage-out

      - run:
          name: Cleanup
          when: always
          command: docker compose down -v || true

  sonar_scan:
    executor: sonar_exec
    environment:
      SONAR_HOST_URL: "https://sonarcloud.io"
      SONAR_ORG: "bradencalebperumal"
      SONAR_PROJECT_KEY: "bradencalebperumal_INSY7314POE"
    steps:
      - checkout
      - attach_workspace:
          at: .

      - run:
          name: Place coverage where Sonar expects it
          command: |
            mkdir -p INSY7314-PAYMENT_PORTAL/backend/coverage
            cp -f coverage-out/lcov.info INSY7314-PAYMENT_PORTAL/backend/coverage/lcov.info

      - run:
          name: Run SonarCloud scan
          command: |
            sonar-scanner \
              -Dsonar.host.url="${SONAR_HOST_URL}" \
              -Dsonar.login="${SONAR_TOKEN}" \
              -Dsonar.organization="${SONAR_ORG}" \
              -Dsonar.projectKey="${SONAR_PROJECT_KEY}" \
              -Dsonar.projectName="INSY7314POE" \
              -Dsonar.projectBaseDir="INSY7314-PAYMENT_PORTAL" \
              -Dsonar.sources="backend/src,frontend/src" \
              -Dsonar.javascript.lcov.reportPaths="backend/coverage/lcov.info" \
              -Dsonar.sourceEncoding="UTF-8" \
              -Dsonar.exclusions="**/node_modules/**,**/dist/**,**/build/**"

workflows:
  pipeline:
    jobs:
      - test_in_docker
      - sonar_scan:
          requires:
            - test_in_docker
